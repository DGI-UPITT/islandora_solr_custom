<?php

// $Id$


/**
 * @file
 * Configuration module for islandora_solr_search.module
 */

/**
 * Implementations of hook_init()
 * Including css for the admin page.
 */
 
function islandora_solr_custom_init() {
  // adds css. I should look for an alternative place to load this because hook_init() will load this on every page.
  drupal_add_css(drupal_get_path('module', 'islandora_solr_custom') .'/css/islandora_solr_custom.css');

}

/**
 * Implementation of hook_alter_form.
 * Adds this module's configuration options to islandora_solr_search's configuration page.
 */

function islandora_solr_custom_form_islandora_solr_admin_settings_alter(&$form, &$form_state) {
  $module   = 'islandora_solr_custom';
  $file     = 'IslandoraSolrResultsCustom.inc';
  $class    = 'IslandoraSolrResultsCustom';
  $method   = 'displayResults';
  $config_options = $form['islandora_solr_config_options']['#options'];
  $config_options["${module}~${file}~${class}~${method}"] = 'Custom';
  $form['islandora_solr_config_options']['#options'] = $config_options;
  
  // dsm($form);
}


/**
 * Implementation of hook_help()
 */

function islandora_solr_custom_help($path, $arg) {

  switch ($path) {
    case 'admin/help#islandora_solr_config':
      return t("When 'Custom Solr Configuration Settings' is selected from the configuration drop-down in the<br />
        !page the following settings will be used.
        <ul>
        <li>Module - islandora_solr_custom</l1>
        <li>File - IslandoraSolrResultsCustom.inc</l1>
        <li>Class - IslandoraSolrResultsCustom</l1>
        <li>Method - displayResults</l1>
        </ul>
        ", array('!page' => l("Islandora_solr_search configuration page", 'admin/settings/islandora_solr_search'),)


      );
  }
}

/**
 * Implementation of hook_theme()
 */
 
 function islandora_solr_custom_theme() {
   return array(
     'islandora_solr_custom' => array(
       'template' => 'islandora_solr_custom',
       'arguments' => array('results_raw' => NULL, 'extra' => NULL),
     ),
   );
 
 }
 
 /**
  * Theme function for theming the solr search results
  *
  * @param $results
  * The raw search results
  *
  * @return variables to be used in the template file.
  */
  
function islandora_solr_custom_preprocess_islandora_solr_custom(&$variables) {
  global $base_url;
  $variables['base_url'] = $base_url;

  foreach ($variables['results_raw']->response->docs as $doc) {
      $resultsArray = array();
      foreach ($doc as $field => $value) {

        if (is_array($value)) {
          $value = implode(", ", $value);
        }
        $resultsArray[$field]['value'] = $value;
        $resultsArray[$field]['label'] = $field;
        // turn the field name in a string that is appropriate to use as a class name.
        $resultsArray[$field]['class'] = strtolower( preg_replace('/[^A-Za-z0-9]/', '-', $field) );
      }

  // dsm($resultsArray);
  $variables['results'][] = $resultsArray;





  }
}

/**
 * Implementation of hook_menu()
 */
 
function islandora_solr_custom_menu() {
  $items['admin/settings/islandora_solr_search/config'] = array(
    'title' => 'Islandora Solr Client',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/settings/islandora_solr_search/custom'] = array(
    'title' => 'Islandora Solr customization',
    'description' => 'Customizing Islandora Solr output results',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_solr_custom_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'islandora_solr_custom.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}




/**
 * Function to render the custom markup
 * @return uses the given solr fields to render sample code to copy into islandora_solr_custom.tpl.php
 */
 
function _islandora_solr_custom_markup_render($markup) {

  $output = '';
  
  $output .= '<div class="form-item">';
  $output .= '<p>'.t('In your theme create a template file called islandora_solr_custom.tpl.php and paste in the code below. This will give you a nice start to customize your solr search results. You can then add wrapper elements, change labels, generate images from the repository, etc. Don\'t forget to rebuild the theme registry after doing this.').'</p>';
  $output .= '<pre>';
  $output .= _islandora_solr_custom_markup_div($markup);
  $output .= '</pre>';
  $output .= '</div>'; 
  // dsm($markup);
  return $output;
}

/**
 * Function to render the div markup
 * @return div markup
 */
 
function _islandora_solr_custom_markup_div($markup) {

  // split $markup into arrays
  // $markup = nl2br($markup);
  $markup = explode("\r\n", $markup);
  // $markup = str_replace("\r\n", '', $markup);
  // dsm($markup);
  
  // set $output variable
  $output = '';
  
  // add standard header markup
  $output .= _islandora_solr_custom_markup_description('start');
  
  foreach ($markup as $field) {
  
  $output .= check_plain('  <div class="solr-field <?php print $result[\''.$field.'\'][\'class\']; ?>">  
      <label><?php print t($result[\''.$field.'\'][\'label\']); ?></label>
      <div class="value"><?php print $result[\''.$field.'\'][\'value\']; ?></div>
    </div>
  ');
  }
  
  $output .= _islandora_solr_custom_markup_description('end');
  return $output;
}

/**
 * Function that holds the standard markup description.
 * @return Standard markup description.
 */
 
function _islandora_solr_custom_markup_description($pos) {

  switch ($pos) {
    case 'start':
      return check_plain('<?php
// $Id $
/**
 * @file islandora_solr_custom.tpl.php
 * Islandora solr search results template
 *
 * Variables available:
 * - $base_url: The base url of the current website. eg: http://example.com .
 * - $user: The user object.
 *
 */
?>
<ul class="islandora_solr_results">
<?php foreach ($results as $id => $result): ?>
  <li class="islandora_solr_result">
  ');
      break;
    
    case 'end':
      return check_plain('</li>
<?php endforeach; ?>
</ul>
');
      break;
  }
}


/**
 * Function that connects to solrconfig.xml
 * @return an array that contains all the solr fields that are set in solrconfig.xml in <str name="fl"> ... </str>
 */
 
function _islandora_solr_custom_solrconfig() {

  // xpath experiment

  $xmlDoc = new DOMDocument();
  $xmlFile = 'http://' . variable_get('islandora_solr_search_block_url', 'localhost:8080/solr') . '/admin/file/?file=solrconfig.xml';
  $xmlDoc->load($xmlFile, LIBXML_NOCDATA);
  $xpath = new DOMXPath($xmlDoc);

  // xPath query.
  // variable wich states which requestHandler we're dealing with.
  $requestHandlerVariable = variable_get('islandora_solr_search_block_request_handler', t('standard'));
  $query = '//requestHandler[@name="'. $requestHandlerVariable .'"]//str[@name="fl"]';

  $entries = $xpath->query($query);  
  
  $result = '';
  foreach ($entries as $entry) {
    $result .= "{$entry->nodeValue}";
  }

  // exploding $result into an array
  $result = explode(',', $result);

  return $result;

}



